<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Simple Sos Debugging - Will&#39;s Blog</title>
<meta name="description" content="Follow along at home:
The following is based on the docker images and dotnet core application located at the repository here">
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Will\u0027s Blog",
    
    "url": "http:\/\/me.wvk.au\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "http:\/\/me.wvk.au\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "http:\/\/me.wvk.au\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "http:\/\/me.wvk.au\/posts\/simple-sos-debugging\/",
          "name": "Simple sos debugging"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "Simple Sos Debugging",
  "description" : "Follow along at home: The following is based on the docker images and dotnet core application located at the repository here\n",
  "inLanguage" : "en",
  "wordCount":  768 ,
  "datePublished" : "2020-04-25T21:18:10",
  "dateModified" : "2020-04-25T21:18:10",
  "image" : "http:\/\/me.wvk.au\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "http:\/\/me.wvk.au\/posts\/simple-sos-debugging\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "http:\/\/me.wvk.au\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "http:\/\/me.wvk.au\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Simple Sos Debugging" />
<meta property="og:description" content="Follow along at home:
The following is based on the docker images and dotnet core application located at the repository here">
<meta property="og:url" content="http://me.wvk.au/posts/simple-sos-debugging/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Will&#39;s Blog" />
<link rel="apple-touch-icon" sizes="180x180" href=" http://me.wvk.au/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://me.wvk.au/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://me.wvk.au/favicon/favicon-16x16.png">


<meta name="generator" content="Hugo 0.144.1">
<link rel="alternate" href="http://me.wvk.au/index.xml" type="application/rss+xml" title="Will&#39;s Blog">
<script src="http://me.wvk.au/js/dark-mode.js"></script><link rel="stylesheet" href="http://me.wvk.au/style.min.css">







  </head>
  <body>
    
<div class="container fixed-top mw-100">
  <div class="row justify-content-center">
    <div class="col-sm-12 col-md-12 col-lg-10 col-xl-10">

      <nav class="navbar navbar-expand-lg navbar-light fixed-top p-0">
        <div class="container">

          <a class="navbar-brand fw-bold" href="http://me.wvk.au/">Will&#39;s Blog</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav mb-2 mb-lg-0 align-items-baseline">
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="blog"
                  href="http://me.wvk.au/posts/"> blog</a>
              </li>

              
              
              

              <li class="nav-item">

                
                
                
                
                

                <a class="nav-link " title="about"
                  href="http://me.wvk.au/about/"> about</a>
              </li>

              
              

              <li class="nav-item nav-link">
                <a id="dark-mode-toggle" class="bi bi-moon-stars" role="button"></a>
              </li>

              
            </ul>

            
          </div>
        </div>
      </nav>

    </div>
  </div>
</div>

    









<header class="header-section ">

  <div class="intro-header no-img mt-10">
    <div class="container">
      <div class="row justify-content-center">
        

          
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            

            <div class="posts-heading">
              

              

              
              <h1 class="fw-semibold display-5 lh-1 mb-3"> 
                Simple Sos Debugging
                
              </h1>
              
              

              

              
              
              
            </div>
          </div>
          
        </div>
        
        
    </div>
  </div>
</header>



    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 ">

      <div class="card-image card-image-blog p-0">
        
        


        
      </div>
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
      <article role="main" class="blog-post">
        <h2 id="follow-along-at-home">Follow along at home:</h2>
<p>The following is based on the docker images and dotnet core application located at the repository <a href="https://github.com/wilvk/dotnet-sos">here</a></p>
<h2 id="getting-started">Getting started:</h2>
<p>To begin with, start up the docker container:</p>
<pre tabindex="0"><code>make llvm
</code></pre><p>Then when in the container, build the solution and start the lldb debugger</p>
<pre tabindex="0"><code>make d-build-debug

make d-llvm-method-breakpoint
</code></pre><p>Once the program has started up, get a list of the clr stack with registers:</p>
<pre tabindex="0"><code>clrstack -r
</code></pre><p>We will see the <code>Child SP</code> and the <code>IP Call Site</code></p>
<p>Using the <code>IP Call Site</code>, call <code>ip2md</code> to get the address of the method descriptor for the currently running instruction.</p>
<pre tabindex="0"><code>ip2md 00007FFF7CE92690
</code></pre><p>This gives us a lot of useful information including the <code>Class</code>, <code>MethodTable</code>, <code>Module</code> and <code>CurrentCodeAddr</code></p>
<p>e.g.</p>
<pre tabindex="0"><code>(lldb) ip2md 00007FFF7CE92690
MethodDesc:   00007fff7cf3ff60
Method Name:          console.Program.GetTicksElapsed(Int64)
Class:                00007fff7cf81dc0
MethodTable:          00007fff7cf3ff88
mdToken:              0000000006000002
Module:               00007fff7cf3db98
IsJitted:             yes
Current CodeAddr:     00007fff7ce92690
Version History:
  ILCodeVersion:      0000000000000000
  ReJIT ID:           0
  IL Addr:            0000000000000000
     CodeAddr:           00007fff7ce92690  (MinOptJitted)
     NativeCodeVersion:  0000000000000000
Source file:  /work/source/own/test_debug/Program.cs @ 19
</code></pre><p>Then, if we want to look at all the methods in the object associated with this table, we can dump the method table at the address of <code>MethodTable</code> shown.</p>
<p>e.g.</p>
<pre tabindex="0"><code>(lldb) dumpmt -MD 00007fff7cf3ff88
EEClass:         00007FFF7CF81DC0
Module:          00007FFF7CF3DB98
Name:            console.Program
mdToken:         0000000002000002
File:            /work/source/own/test_debug/bin/Debug/netcoreapp3.1/test_debug.dll
BaseSize:        0x18
ComponentSize:   0x0
DynamicStatics:  false
ContainsPointers false
Slots in VTable: 7
Number of IFaces in IFaceMap: 0
--------------------------------------
MethodDesc Table
           Entry       MethodDesc    JIT Name
00007FFF7CE80090 00007FFF7C48C728   NONE System.Object.Finalize()
00007FFF7CE80098 00007FFF7C48C738   NONE System.Object.ToString()
00007FFF7CE800A0 00007FFF7C48C748   NONE System.Object.Equals(System.Object)
00007FFF7CE800B8 00007FFF7C48C788   NONE System.Object.GetHashCode()
00007FFF7CE8BEA0 00007FFF7CF3FF78   NONE console.Program..ctor()
00007FFF7CE908A0 00007FFF7CF3FF48    JIT console.Program.Main(System.String[])
00007FFF7CE92690 00007FFF7CF3FF60    JIT console.Program.GetTicksElapsed(Int64)
</code></pre><p>In the column <code>JIT</code> we can see that our two methods in our application have been JITT-ed at runtime, whereas other methods that are part of this object have not been.</p>
<h2 id="tracing-an-object-back-to-its-ancestors">Tracing an object back to it&rsquo;s ancestors</h2>
<p>From <code>dumpmt</code>, we can see the value <code>EEClass</code> which is the address of the descriptor for the object <code>console.Program</code>.</p>
<p>If we then run <code>dumpclass</code> on this address we can see more info about this class.</p>
<pre tabindex="0"><code>(lldb) dumpclass 00007FFF7CF81DC0
Class Name:      console.Program
mdToken:         0000000002000002
File:            /work/source/own/test_debug/bin/Debug/netcoreapp3.1/test_debug.dll
Parent Class:    00007fff7ce77fe8
Module:          00007fff7cf3db98
Method Table:    00007fff7cf3ff88
Vtable Slots:    4
Total Method Slots:  5
Class Attributes:    100000
NumInstanceFields:   0
NumStaticFields:     0
</code></pre><p>We can see the <code>Parent Class</code> address here and <code>Module</code> address. the <code>Method Table</code> is the same as what we just saw.</p>
<p>Running <code>dumpclass</code> again with the <code>Parent Class</code> address this time, we can see what <code>console.Program</code> is inherited from:</p>
<pre tabindex="0"><code>(lldb) dumpclass 00007fff7ce77fe8
Class Name:      System.Object
mdToken:         0000000002000057
File:            /usr/share/dotnet/shared/Microsoft.NETCore.App/3.1.1/System.Private.CoreLib.dll
Parent Class:    0000000000000000
Module:          00007fff7c484020
Method Table:    00007fff7c48c798
Vtable Slots:    4
Total Method Slots:  5
Class Attributes:    102001
NumInstanceFields:   0
NumStaticFields:     0
</code></pre><p>This shows that <code>parent.Console</code> inherits from <code>System.Object</code>. we can also see that the name of <code>File</code> has changed from our application to <code>System.Private.CoreLib.dll</code>, indicating that it is a dotnet core framework library.</p>
<p>We can also see that the <code>Parent Class</code> value is <code>0</code> indicating this is the base object of our application (and of the dotnet core framework library).</p>
<p>If <code>program.Console</code> inherits from <code>System.Object</code>, and our source code only has two methods, namely:</p>
<ul>
<li><code>console.Program.Main(System.String[])</code></li>
<li><code>console.Program.GetTicksElapsed(Int64)</code></li>
</ul>
<p>We would expect that the other methods shown earlier must be inherited from <code>System.Object</code>. to verify this, we can run <code>dump -MD</code> with the address of the <code>Method Table</code> shown in order to do so:</p>
<pre tabindex="0"><code>(lldb) dumpmt -MD 00007fff7c48c798
EEClass:         00007FFF7CE77FE8
Module:          00007FFF7C484020
Name:            System.Object
mdToken:         0000000002000057
File:            /usr/share/dotnet/shared/Microsoft.NETCore.App/3.1.1/System.Private.CoreLib.dll
BaseSize:        0x18
ComponentSize:   0x0
DynamicStatics:  false
ContainsPointers false
Slots in VTable: 9
Number of IFaces in IFaceMap: 0
--------------------------------------
MethodDesc Table
           Entry       MethodDesc    JIT Name
00007FFF7CE80090 00007FFF7C48C728   NONE System.Object.Finalize()
00007FFF7CE80098 00007FFF7C48C738   NONE System.Object.ToString()
00007FFF7CE800A0 00007FFF7C48C748   NONE System.Object.Equals(System.Object)
00007FFF7CE800B8 00007FFF7C48C788   NONE System.Object.GetHashCode()
00007FFF7CE80088 00007FFF7C48C718   NONE System.Object..ctor()
00007FFF7CE80078 00007FFF7C48C6E8   NONE System.Object.GetType()
00007FFF7CE80080 00007FFF7C48C700   NONE System.Object.MemberwiseClone()
00007FFF7CE800A8 00007FFF7C48C758   NONE System.Object.Equals(System.Object, System.Object)
00007FFF7CE800B0 00007FFF7C48C770   NONE System.Object.ReferenceEquals(System.Object, System.Object)
</code></pre><p>Looking at the <code>MethodDesc</code> table from the output does infact show the same method names and associated addresses:</p>
<pre tabindex="0"><code>console.Program:

00007FFF7CE80090 00007FFF7C48C728   NONE System.Object.Finalize()
00007FFF7CE80098 00007FFF7C48C738   NONE System.Object.ToString()
00007FFF7CE800A0 00007FFF7C48C748   NONE System.Object.Equals(System.Object)
00007FFF7CE800B8 00007FFF7C48C788   NONE System.Object.GetHashCode()

System.Object:

00007FFF7CE80090 00007FFF7C48C728   NONE System.Object.Finalize()
00007FFF7CE80098 00007FFF7C48C738   NONE System.Object.ToString()
00007FFF7CE800A0 00007FFF7C48C748   NONE System.Object.Equals(System.Object)
00007FFF7CE800B8 00007FFF7C48C788   NONE System.Object.GetHashCode()
</code></pre><h3 id="inspecting-other-components">Inspecting other components:</h3>
<p>From our <code>dumpmt</code> of <code>console.Program</code> earlier, we can use the <code>Module Address</code> to get more details about our application&rsquo;s assembly loaded into memory:</p>
<pre tabindex="0"><code>(lldb) dumpmodule 00007fff7cf3db98
Name:       /work/source/own/test_debug/bin/Debug/netcoreapp3.1/test_debug.dll
Attributes: PEFile SupportsUpdateableMethods
Assembly:   0000000000691510
PEFile:                  000000000068F7C0
ModuleId:                00007FFF7CF3E150
ModuleIndex:             0000000000000001
LoaderHeap:              0000000000000000
TypeDefToMethodTableMap: 00007FFF7CF279B0
TypeRefToMethodTableMap: 00007FFF7CF279C8
MethodDefToDescMap:      00007FFF7CF27A58
FieldDefToDescMap:       00007FFF7CF27A78
MemberRefToDescMap:      0000000000000000
FileReferencesMap:       00007FFF7CF27A88
AssemblyReferencesMap:   00007FFF7CF27A90
MetaData start address:  00007FFFF7E3F2CC (1540 bytes)
</code></pre><p>Then using the <code>Assembly</code> address, we can dump the assembly details:</p>
<pre tabindex="0"><code>(lldb) dumpassembly 0000000000691510
Parent Domain:      000000000062d820
Name:               /work/source/own/test_debug/bin/Debug/netcoreapp3.1/test_debug.dll
ClassLoader:        0000000000721890
  Module
  00007fff7cf3db98    /work/source/own/test_debug/bin/Debug/netcoreapp3.1/test_debug.dll
</code></pre><p>Well, that was fun. I hope you enjoyed following along!</p>

      </article>
    </div>
  </div>

  
  <div class="row">
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
      <hr class="m-0"/>
    </div>
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-2">
      
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
      
    </div>

    
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 mt-3">
      <div class="card">
        <div class="row no-gutters">
          <div class="col-md-2 ">
            <div class="card-body ">
              
              <img src="http://me.wvk.au/img/bino-about-small.jpg" class="img-responsive img-50 img-round" alt="">
            </div>
          </div>


          <div class="col-md-10">
            <div class="card-body p-1.1">
              <p class="p-0 m-0"><small class="text-muted">Written By</small></p>
              <p class="card-text fs-5 m-0">

                
                
                

              </p>
              
            </div>
          </div>
        </div>
      </div>
    </div>
    

    <div class="col-lg-8 offset-lg-2 col-md-12 offset-md-1 pt-4">
      
      <ul class="list-group list-group-horizontal" style="flex-direction: row">
        
        <li class="list-group-item b-0 p-0">

          <a type="button" class="btn btn-dark" role="button" href="http://me.wvk.au/posts/troubleshooting-a-dotnet-vim-plugin/"
            data-toggle="tooltip" data-placement="top" title="Troubleshooting a Vim dotnet Plugin">&larr;
            Previous Post</a>
        </li>
        


        
        <li class="list-group-item ms-auto b-0 p-0">
          <a type="button" class="btn btn-dark" role="button" href="http://me.wvk.au/posts/understanding-dotnet-core-pdb-files/"
            data-toggle="tooltip" data-placement="top" title="Understanding Dotnet Core Pdb Files">Next Post
            &rarr;</a>
        </li>
        
      </ul>
      
    </div>

    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 pt-4">
    </div>
  </div>
  
</div>

<div class="">
  
  

  

</div>

    


<footer>

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <ul
          class="list-inline list-group list-group-horizontal text-center footer-links d-flex justify-content-center flex-row">

          
          
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
          2020
          

          
          &nbsp;&bull;&nbsp;
          <a href="http://me.wvk.au/">Will&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          Powered by <a href="https://gohugo.io">Hugo</a> & <a href="https://github.com/binokochumolvarghese/lightbi-hugo">Lightbi.</a>&nbsp; Made with ❤ by <a href="https://binovarghese.com">Bino</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    
  </body>
</html>

